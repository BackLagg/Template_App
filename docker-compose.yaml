services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
    container_name: fabricbot-frontend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    environment:
      REACT_APP_API_BASE_URL: ${REACT_APP_API_BASE_URL:-https://fabricbot.tech/api}
      API_BASE_URL: ${API_BASE_URL:-https://fabricbot.tech/api}
    networks:
      - fabricbot-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider --timeout=5 http://localhost/ && exit 0 || exit 1"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: 40s

  nginx:
    image: nginx:alpine
    pull_policy: always
    container_name: fabricbot-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl/live:/etc/letsencrypt/live:ro
      - ./logs/nginx:/var/log/nginx
    environment:
      - NGINX_HOST=fabricbot.tech
      - NGINX_PORT=80
    command: >
      sh -c "
        rm -f /etc/nginx/conf.d/default.conf &&
        nginx -g 'daemon off;'
      "
    networks:
      - fabricbot-network
    depends_on:
      - frontend
      - backend
      - file-service
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}

  mongo:
    image: mongo:7-jammy
    container_name: fabricbot-mongo
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - fabricbot-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  file-service:
    build:
      context: ./file-service
      dockerfile: Dockerfile
    container_name: fabricbot-file-service
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3002
      FILE_API_KEY: ${FILE_API_KEY:-}
      STORAGE_TYPE: ${FILE_STORAGE_TYPE:-local}
    volumes:
      - file_uploads:/app/uploads
      - ./logs/file-service:/app/logs
    networks:
      - fabricbot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: 10s
      retries: 3
      start_period: 15s

  backend-redis:
    image: redis:7-alpine
    container_name: backend-redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-some-password}
      --appendonly yes
      --appendfsync everysec
    volumes:
      - backend_redis_data:/data
    networks:
      - fabricbot-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD:-some-password} ping | grep -q PONG"]
      interval: 10s
      timeout: 3s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: fabricbot-backend
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      BACKEND_PORT: 8080
      BACKEND_BASE_URL: ${BACKEND_BASE_URL:-https://fabricbot.tech/api}
      MONGO_URI: mongodb://mongo:27017/${MONGO_DB_NAME:-ref-app}
      REDIS_HOST: backend-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-some-password}
      BOT_TOKEN: ${BOT_TOKEN}
      BOT_USERNAME: ${BOT_USERNAME:-fabricbotbot}
      FILE_SERVICE_URL: http://file-service:3002
      FILE_API_KEY: ${FILE_API_KEY:-}
      FILE_PUBLIC_URL: ${FILE_PUBLIC_URL:-https://fabricbot.tech}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000}
    volumes:
      - ./logs/backend:/app/logs
    networks:
      - fabricbot-network
    depends_on:
      mongo:
        condition: service_healthy
      backend-redis:
        condition: service_started
      file-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: 40s

  bot:
    build:
      context: ./Bot_API
      dockerfile: Dockerfile
    container_name: fabricbot-bot
    restart: unless-stopped
    environment:
      MONGO_URI: mongodb://mongo:27017/${MONGO_DB_NAME:-ref-app}
      BOT_TOKEN: ${BOT_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      DB_NAME: ${MONGO_DB_NAME:-ref-app}
      USERS_COLLECTION: ${USERS_COLLECTION:-users}
      USERS_PROFILE_COLLECTION: ${USERS_PROFILE_COLLECTION:-profiles}
      SUPERUSER_COLLECTION: ${SUPERUSER_COLLECTION:-superusers}
      MINIAPP_URL: ${MINIAPP_URL:-https://fabricbot.tech}
      SUPER_ADMIN_ID: ${SUPER_ADMIN_ID}
      BACKEND_URL: http://backend:8080
    volumes:
      - ./logs/bot:/app/logs
    networks:
      - fabricbot-network
    depends_on:
      backend:
        condition: service_healthy
      mongo:
        condition: service_healthy

volumes:
  mongo_data:
    driver: local
  backend_redis_data:
    driver: local
    name: backend-redis-data
  file_uploads:
    driver: local

networks:
  fabricbot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
