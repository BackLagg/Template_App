# File Service

Универсальный файловый сервис с поддержкой S3 и локального хранилища.

## Описание

Этот сервис предоставляет единый API для работы с файлами, автоматически выбирая между S3 и локальным хранилищем в зависимости от доступности.

## Содержание

- [Описание](#описание)
- [Возможности](#возможности)
- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [Запуск](#запуск)
  - [Development](#development)
  - [Production](#production)
- [Тестирование](#тестирование)
  - [Запуск тестов](#запуск-тестов)
  - [Структура тестов](#структура-тестов)
  - [Покрытие кода](#покрытие-кода)
- [API](#api)
  - [Загрузка файла](#загрузка-файла)
  - [Удаление файла](#удаление-файла)
  - [Проверка существования файла](#проверка-существования-файла)
  - [Получение файла](#получение-файла)
  - [Статус сервиса](#статус-сервиса)
  - [Health Check](#health-check)
- [Логика работы](#логика-работы)
- [Расширяемость](#расширяемость)
- [Безопасность](#безопасность)

## Возможности

- ✅ Автоматический выбор между S3 и локальным хранилищем
- ✅ Проверка доступности S3 при старте
- ✅ Фолбэк на локальное хранилище при недоступности S3
- ✅ Универсальный API для работы с файлами
- ✅ Безопасная аутентификация через API ключ (защита от timing attacks)
- ✅ Поддержка различных типов файлов
- ✅ Автоматическое создание папок для хранения
- ✅ Потоковая передача файлов (streaming) для эффективной работы с большими файлами
- ✅ Компрессия ответов (gzip/brotli)
- ✅ Rate limiting для защиты от злоупотреблений
- ✅ Graceful shutdown для корректного завершения работы
- ✅ Валидация файлов по содержимому (magic numbers)
- ✅ Защита от path traversal атак

## Установка

```bash
npm install
```

## Конфигурация

Скопируйте `.env.example` в `.env` и настройте переменные окружения. Все доступные переменные и их описание находятся в файле `.env.example`.

## Запуск

### Development

```bash
npm run dev
```

### Production

```bash
npm run build
npm start
```

## Тестирование

Проект использует Jest для тестирования. Доступны следующие команды:

### Запуск тестов

```bash
# Запуск всех тестов
npm test

# Запуск тестов в режиме watch
npm run test:watch

# Запуск тестов с покрытием кода
npm run test:coverage

# Запуск тестов для CI/CD
npm run test:ci
```

### Структура тестов

Тесты организованы по модулям:

- **Unit тесты**:
  - `config/` - тесты конфигурации
  - `utils/` - тесты утилит (валидация файлов, работа с путями, MIME типы и т.д.)
  - `services/` - тесты сервисов (локальное хранилище, S3, кэш, регистрация хранилищ)
  - `middleware/` - тесты middleware (аутентификация, обработка ошибок)

- **Интеграционные тесты**:
  - `integration/` - тесты API endpoints

### Покрытие кода

Отчеты о покрытии кода генерируются в директории `coverage/`. HTML отчет доступен в `coverage/lcov-report/index.html`.

## API

### Загрузка файла

```http
POST /api/upload
X-API-Key: your-api-key
Content-Type: multipart/form-data

file: [binary]
folder: products
prefix: product
```

**Ответ:**
```json
{
  "success": true,
  "filename": "product-1234567890-987654321.jpg",
  "url": "https://...",
  "path": "/files/products/product-1234567890-987654321.jpg",
  "size": 102400
}
```

### Удаление файла

```http
DELETE /api/delete
X-API-Key: your-api-key
Content-Type: application/json

{
  "path": "/files/products/product-123.jpg"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "File deleted successfully"
}
```

### Проверка существования файла

```http
GET /api/exists?path=/files/products/product-123.jpg
X-API-Key: your-api-key
```

**Ответ:**
```json
{
  "exists": true
}
```

### Получение файла

```http
GET /files/products/product-123.jpg
```

Публичный endpoint, не требует API ключ. Файлы отдаются через потоковую передачу.

### Статус сервиса

```http
GET /api/status
X-API-Key: your-api-key
```

**Ответ:**
```json
{
  "available": true,
  "storageType": "s3",
  "timestamp": "2025-01-27T12:00:00.000Z"
}
```

### Health Check

```http
GET /health
```

Публичный endpoint для проверки работоспособности сервиса.

## Логика работы

1. При старте сервис регистрирует доступные провайдеры хранилищ
2. Хранилища проверяются в порядке приоритета (S3 → другие → Local)
3. Первое доступное хранилище используется для всех операций
4. Если S3 недоступен - автоматически используется локальное хранилище
5. Все операции выполняются через единый интерфейс
6. Файлы передаются через потоковую передачу для эффективной работы с большими файлами

## Расширяемость

Сервис поддерживает систему регистрации хранилищ, что позволяет легко добавлять новые типы хранилищ (Azure Blob, Google Cloud Storage, MinIO и т.д.) без изменения основного кода. Подробнее см. `STORAGE_PROVIDERS.md`.

## Безопасность

- **Аутентификация**: Все административные операции требуют API ключ в заголовке `X-API-Key`
- **Защита от timing attacks**: Используется безопасное сравнение ключей через `crypto.timingSafeEqual()`
- **Path traversal защита**: Все пути нормализуются и валидируются перед использованием
- **Валидация файлов**: Проверка расширения, MIME типа и содержимого файла (magic numbers)
- **Rate limiting**: Ограничение количества запросов с одного IP адреса
- **HTTPS enforcement**: Возможность принудительного использования HTTPS в production
- **CORS**: Настраиваемая политика CORS для контроля доступа

